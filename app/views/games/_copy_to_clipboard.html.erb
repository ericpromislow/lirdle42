<%
  Rails.logger.debug("QQQ: In copy-to-clipboard, outcome: #{ @outcome }")
%>
<button class="button" type="button" id="shareResults">Copy to Clipboard</button>
<script>
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;

    // Avoid scrolling to bottom
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
      const successful = document.execCommand('copy');
      const msg = successful ? 'successful' : 'unsuccessful';
      console.log('Fallback: Copying text command was ' + msg);
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
    }

    document.body.removeChild(textArea);
  }

  function copyTextToClipboard(text) {
    if (!navigator.clipboard) {
      fallbackCopyTextToClipboard(text);
      return;
    }
    navigator.clipboard.writeText(text).then(function() {
      console.log('navigator.clipboard.writeText worked');
    }, function(err) {
      console.error(`navigator.clipboard.writeText failed: ${ e }`);
      fallbackCopyTextToClipboard(text);
    });
  }
  function getShareText() {
    <%
     guesses = @game_state.guesses
     %>
    const scoreLines = [];
    scoreLines.push(`Results from ${ new Date() }:`);
    scoreLines.push('');
    scoreLines.push('<%= @outcome %>');
    scoreLines.push('');
    scoreLines.push(`Your word: <%=@other_state.finalWord  %> `);
    scoreLines.push('');
    scoreLines.push(`Your guesses:`);
    scoreLines.push(`<%= guesses.map(&:word).join(' ') %>`);
    scoreLines.push('');
    scoreLines.push(`Their word: <%= @game_state.finalWord  %>`);
    scoreLines.push('');
    scoreLines.push(`Their guesses:`);
    scoreLines.push(`<%= @other_state.guesses.map(&:word).join(' ') %>`);
    scoreLines.push('');
    scoreLines.push('lirdle42.com - the word game where you get to lie');
    return scoreLines.join('\n');
  }

  $(document).ready(() => {
    const shareResults = document.getElementById('shareResults');
    shareResults.addEventListener('click', (e) => {
      const shareText = getShareText();
      try {
        copyTextToClipboard(shareText);
      } catch (e) {
        console.log(`Trying to share failed: ${err}`);
      }
    });
  });
</script>
